define([angular],function(){return function(e,a,n,i){e.directive("p2pUpload",function(){return{scope:{p2pUploadWrap:"@p2pUploadWrap",p2pUploadContainer:"@p2pUploadContainer",p2pUploadPicker:"@p2pUploadPicker",p2pUploadDomain:"=p2pUploadDomain",uploadFile:"=uploadFile",uploadKey:"&uploadKey"},restrict:"A",template:'<div class="upload-wrap" id=""><div class="img-preview" ng-show="uploadFile.length" ><div class="item" ng-repeat="item in uploadFile"><img ng-src="{{ p2pUploadDomain+item}}?imageView2/1/w/110/h/70"><span ng-click="itemRemove(this,$index)" class="remove">×</span></div></div><div id="container" class="container"><a class="btn btn-default btn-lg pickfiles" id="pickfiles" href="javascript:;"  ><i class="glyphicon glyphicon-plus"></i><sapn>选择文件</sapn></a></div></div>',replace:!0,link:function(e,n,i,l){function p(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var a=16*Math.random()|0,n="x"==e?a:3&a|8;return n.toString(16)})}function t(e,a,n){for(var i=e.getElementsByTagName(n),l=[],p=0;p<i.length;p++)for(var t=0,o=i[p].className.split(" ");t<o.length;t++)if(o[t]==a){l.push(i[p]);break}return l}var o=[];e.uploaderImages=[],n[0].id=e.p2pUploadWrap,e.itemRemove=function(a,n){angular.element(a).parent().remove(),e.uploadFile.splice(n,1),e.uploadKey()},e.build=function(e,a,n){function i(){o&&(o.remove(),p.remove(),o=null)}function l(e,a){t=angular.element(document.body),p=angular.element('<div class="rd-image-preview-conta"><img src="'+e.attr("src").replace(/\?[\w\W]*/,"")+'" /></div>'),o=angular.element('<div class="rd-mask"></div>').off("click").on("click",function(){i()}),r=angular.element('<a class="prev-btn"></a>').on("click",function(){a>0&&(i(),l(angular.element(d[a-1]),a-1))}),s=angular.element('<a class="next-btn"></a>').on("click",function(){a<d.length-1&&(i(),l(angular.element(d[a+1]),a+1))}),a>0&&p.append(r),a<d.length-1&&p.append(s),t.append(o),t.append(p)}var p,t,o,r,s,d;e.src;d=a.find("img"),angular.forEach(d,function(e,a){e=angular.element(e),e.on("click",function(){l(e,a)})})},document.getElementsByClassName?(n[0].getElementsByClassName("container")[0].id=e.p2pUploadContainer,n[0].getElementsByClassName("pickfiles")[0].id=e.p2pUploadPicker):(t(n[0],"container","div")[0].id=e.p2pUploadContainer,t(n[0],"pickfiles","a")[0].id=e.p2pUploadPicker);e.p2pUploadDomain,Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:e.p2pUploadPicker,container:e.p2pUploadContainer,drop_element:e.p2pUploadContainer,flash_swf_url:"resources/plugins/qiniu/demo/js/plupload/Moxie.swf",dragdrop:!0,max_file_size:"2mb",chunk_size:"2mb",uptoken_url:"uptoken",domain:e.p2pUploadDomain,unique_names:!1,save_key:!1,auto_start:!0,filters:{max_file_size:"2mb",mime_types:[{title:"Image files",extensions:"jpg,gif,png,jpeg"}]},init:{FilesAdded:function(e,a){},BeforeUpload:function(e,a){},UploadProgress:function(e,a){},UploadComplete:function(){document.getElementsByClassName?n[0].getElementsByClassName("img-preview")[0].style.display="block":t(n[0],"img-preview","div")[0].style.display="block"},FileUploaded:function(l,p,r){var s=JSON.parse(r);o.push(s.key),e.uploaderImages2=o;e.uploadFile.length;e.$eval("uploadFile = uploaderImages2"),e.$apply(),e.uploadKey(),a=document.getElementsByClassName?n[0].getElementsByClassName("img-preview")[0]:t(n[0],"img-preview","div")[0],e.build(e,n,i)},Error:function(e,a,n){"File size error."==a.message?alert("图片大小过大，请选择2M以内的图片！"):"File extension error."==a.message&&alert("图片的格式错误，请按要求传入正确格式的图片！")},Key:function(a,n){var i="",l=new Date;return i=1==e.$parent.returnKey.type?e.$parent.returnKey.url:e.$parent.returnKey.url+"/"+l.getTime()+"/"+p()}}}),Qiniu.watermark({mode:1,image:"http://www.erongdu.com/templets/rongdu/bg/logo.png",dissolve:50,gravity:"SouthWest",dx:100,dy:100})}}})}});