define(["angular"],function(e){return function(r,a,t,n){r.controller("loginCtrl",["$scope","$rootScope","$state","$window","cService","$location","$cookieStore","G",function(r,a,t,n,o,c,u,s){r.loginNum=!1,r.serverError=!1,r.callError="",r.user.password="",r.hideError=function(){r.serverError=!1},r.checkInputIntFloat=function(e){""!=e.value.replace(/\d{1,}\.{0,1}\d{0,}/,"")&&(e.value=null==e.value.match(/\d{1,}\.{0,1}\d{0,}/)?"":e.value.match(/\d{1,}\.{0,1}\d{0,}/))},r.valid="validCode?t="+Math.random(),r.validCode=function(){document.getElementById("reg-validatecode")&&(r.valid="validCode?t="+Math.random())},o.ajax({url:"users/needValidCode"}).success(function(e,a,t,n){"false"==e?r.loginNum=!1:r.loginNum=!0}),r.sendAgain=function(){o.ajax({url:"users/sentActivateEmail?username="+r.user.username,method:"get"}).success(function(e,r,a,t){alert("邮件已发送")})},r.submit=function(n){var c=e.element(document.getElementById("password")),s=fieldRSA(c);r.serverError=!1;var i={};i=0==r.loginNum?{username:r.user.username,password:s}:{username:r.user.username,password:s,validCode:r.user.validCode},o.ajax({url:"users/login",method:"post",params:i}).success(function(e,n,o,c){r.loginFalse=!1,r.loginSucc=!0;var s=o("lastlockcount"),i=o("isLock"),l=parseInt(s)+1;if(r.totalLockCount=r.totalLockCount>l?r.totalLockCount:l,null!=o("count")&&(r.loginNum=!0),i||null!=s&&0>=s?(r.callError="密码输错超过"+r.totalLockCount+"次，您的账户被锁定",r.serverError=!0):s&&s<=r.totalLockCount-2&&(r.callError="您还有"+s+"次密码输入机会",r.serverError=!0),""!=e){if(a.user=e,u.put("curUser",e),a.login.beforeLogin=!1,a.login.afterLogin=!0,a.$state.preState.name&&-1!=a.$state.preState.name.indexOf("article")||-1!=a.$state.preState.name.indexOf("newuser"))return t.go("home"),!1;if(a.$state.preState.name&&"error"!=a.$state.preState.name&&-1==a.$state.preState.name.indexOf("login")&&-1==a.$state.preState.name.indexOf("register")){var d=a.$state.preState,m=a.$state.nxtState;return a.user.canBorrow||"account.borrowdetail"!=d.name&&"account.back"!=d.name&&"account.credit"!=d.name&&"account.material"!=d.name?a.$state.change||"borrowDetail"!=m.name&&"bondDetail"!=m.name?1!=a.user.userType||-1==d.name.indexOf("account.bankCard")&&"account.myinvest"!=d.name&&"account.payment"!=d.name&&"account.creditorRight"!=d.name&&"account.invitation"!=d.name&&"account.discount"!=d.name?(t.go(d.name,{id:d.currentParams.id,userId:d.currentParams.userId}),!1):(t.go("account.myaccount"),!1):(a.$state.change=!0,t.go(m.name,{id:m.nextPrams.id,userId:m.nextPrams.userId}),!1):(t.go("account.myaccount"),!1)}return t.go("account.myaccount"),!1}r.serverError||(r.callError="用户名或者密码错误",r.serverError=!0),document.getElementById("reg-validatecode")&&r.validCode()}).error(function(e,a,t,n){"8004"==e.code||(r.validCode(),r.callError=e.message,r.serverError=!0)})}}])}});